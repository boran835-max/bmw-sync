<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW 4.20i Path-Sync Pro</title>
    <style>
        body { background: #000; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        video { position: absolute; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }
        canvas#drawCanvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10; touch-action: none; }
        
        .ui-layer { position: absolute; bottom: 20px; z-index: 100; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none; }
        button { pointer-events: auto; padding: 15px 35px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #startBtn { background: #3498db; color: white; }
        #lockBtn { background: #2ecc71; color: white; display: none; }
        
        .status-box { position: absolute; top: 20px; left: 20px; z-index: 100; color: #fff; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 8px; border-left: 4px solid #e74c3c; font-family: monospace; pointer-events: none; }
    </style>
</head>
<body>

    <div class="status-box" id="status">ADIM 1: 'KAMERAYI AÇ' butonuna bas.</div>
    
    <div class="ui-layer">
        <button id="startBtn">KAMERAYI VE SESİ AÇ</button>
        <button id="lockBtn">YOLU KİLİTLE VE SENKRONİZE ET</button>
    </div>

    <video id="liveCam" autoplay muted playsinline></video>
    <canvas id="drawCanvas"></canvas>

<script>
let audioCtx, source, gainNode, filter;
let rawPoints = [];
let pathPoints = []; 
let isDrawing = false;
let isLocked = false;
let lastRpmValue = 0;

const video = document.getElementById('liveCam');
const drawCanvas = document.getElementById('drawCanvas');
const dCtx = drawCanvas.getContext('2d');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const lockBtn = document.getElementById('lockBtn');

// 1. KAMERA VE SESİ BAŞLAT
async function initEngine() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", frameRate: { ideal: 60 } } 
        });
        video.srcObject = stream;
        
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        const response = await fetch('./motor_sesi.WAV?v=' + Date.now());
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;
        
        filter = audioCtx.createBiquadFilter();
        filter.type = "lowpass";
        gainNode = audioCtx.createGain();

        source.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        source.start(0);

        startBtn.style.display = 'none';
        status.innerText = "ADIM 2: Ekranda devir saatinin üzerinden hattı çiz.";
        setupDrawing();
    } catch (err) { alert("Hata: " + err); }
}

// 2. ÇİZİM FONKSİYONLARI
function setupDrawing() {
    drawCanvas.width = window.innerWidth;
    drawCanvas.height = window.innerHeight;

    drawCanvas.addEventListener('touchstart', (e) => {
        if (isLocked) return;
        isDrawing = true;
        rawPoints = [];
        dCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    });

    drawCanvas.addEventListener('touchmove', (e) => {
        if (!isDrawing) return;
        const x = e.touches[0].clientX;
        const y = e.touches[0].clientY;
        rawPoints.push({x, y});
        
        dCtx.strokeStyle = '#e74c3c';
        dCtx.lineWidth = 4;
        dCtx.lineJoin = 'round';
        if (rawPoints.length > 1) {
            dCtx.beginPath();
            dCtx.moveTo(rawPoints[rawPoints.length-2].x, rawPoints[rawPoints.length-2].y);
            dCtx.lineTo(x, y);
            dCtx.stroke();
        }
    });

    drawCanvas.addEventListener('touchend', () => {
        isDrawing = false;
        if (rawPoints.length > 10) {
            calculatePathPoints();
            lockBtn.style.display = 'block';
            status.innerText = "ADIM 3: Çizgi tamamsa 'KİLİTLE'ye bas.";
        }
    });
}

function calculatePathPoints() {
    pathPoints = [];
    const stepCount = 50; // Çizgiyi 50 noktaya bölüyoruz
    for (let i = 0; i < stepCount; i++) {
        const idx = Math.floor((i / (stepCount - 1)) * (rawPoints.length - 1));
        pathPoints.push(rawPoints[idx]);
    }

    dCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    pathPoints.forEach((p, i) => {
        dCtx.fillStyle = i === 0 ? '#3498db' : '#f1c40f';
        dCtx.beginPath();
        dCtx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        dCtx.fill();
    });
}

// 3. ANALİZ DÖNGÜSÜ
function updateLoop() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && isLocked) {
        let activePoints = 0;
        
        // Gizli analiz canvası üzerinden pikselleri tara
        const analysisCanvas = document.createElement('canvas');
        analysisCanvas.width = video.videoWidth;
        analysisCanvas.height = video.videoHeight;
        const aCtx = analysisCanvas.getContext('2d', {alpha: false});
        aCtx.drawImage(video, 0, 0);

        pathPoints.forEach((p, index) => {
            const vx = (p.x / window.innerWidth) * video.videoWidth;
            const vy = (p.y / window.innerHeight) * video.videoHeight;
            const pixel = aCtx.getImageData(vx, vy, 1, 1).data;
            
            // BMW Kırmızısı Takibi: Kırmızı kanal baskın mı?
            if (pixel[0] > 145 && pixel[0] > pixel[1] * 1.6) {
                activePoints = index + 1;
            }
        });

        const rpm = activePoints / 50;
        updateAudio(rpm);
        status.innerText = `BMW 4.20i | RPM: %${Math.round(rpm * 100)}`;
    }
    requestAnimationFrame(updateLoop);
}

function updateAudio(val) {
    const t = audioCtx.currentTime;
    
    // Pop & Bang (Ani devir düşüşünde egzoz patlaması)
    if (lastRpmValue - val > 0.14) {
        gainNode.gain.setValueAtTime(1.5, t);
        gainNode.gain.exponentialRampToValueAtTime(0.3 + (val * 0.7), t + 0.12);
    }
    lastRpmValue = val;

    source.playbackRate.setTargetAtTime(0.8 + (val * 3.4), t, 0.02);
    if (gainNode.gain.value < 1.2) {
        gainNode.gain.setTargetAtTime(0.3 + (val * 0.7), t, 0.02);
    }
    filter.frequency.setTargetAtTime(1200 + (val * 18000), t, 0.02);
}

startBtn.addEventListener('click', () => {
    initEngine();
});

lockBtn.addEventListener('click', () => {
    isLocked = true;
    lockBtn.style.display = 'none';
    dCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    updateLoop();
});
</script>
</body>
</html>
