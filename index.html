<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW 4.20i Audio Fix</title>
    <style>
        body { background: #000; margin: 0; overflow: hidden; font-family: sans-serif; }
        video { position: absolute; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }
        .debug-overlay { 
            position: absolute; top: 10px; left: 10px; z-index: 1000; 
            background: rgba(0,0,0,0.8); color: #00ff00; padding: 10px; 
            font-family: monospace; font-size: 12px; pointer-events: none;
        }
        #startBtn { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; padding: 25px 50px; background: #e74c3c; color: #fff;
            font-weight: bold; border: none; border-radius: 10px; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="debug-overlay" id="status">DURUM: BEKLENİYOR...</div>
    <button id="startBtn">SİSTEMİ VE SESİ BAŞLAT</button>
    <video id="liveCam" autoplay muted playsinline></video>

<script>
let audioCtx, source, gainNode, filter;
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const video = document.getElementById('liveCam');

async function startSystem() {
    status.innerHTML = "KAMERA BAŞLATILIYOR...";
    
    try {
        // 1. Kamera Erişimi
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;

        // 2. Audio Context (Tıklama sonrası başlatılması şart)
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        
        // iOS/Safari için sessizlik kilidini kırma
        if (audioCtx.state === 'suspended') {
            await audioCtx.resume();
        }

        status.innerHTML = "SES DOSYASI YÜKLENİYOR...";
        
        // GitHub'daki büyük harf WAV dosyasını çekiyoruz
        const response = await fetch('./motor_sesi.WAV?v=' + Date.now());
        
        if (!response.ok) {
            throw new Error("Ses dosyası bulunamadı! GitHub'da ismin 'motor_sesi.WAV' olduğundan emin olun.");
        }

        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;

        gainNode = audioCtx.createGain();
        filter = audioCtx.createBiquadFilter();
        
        source.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        source.start(0);
        
        status.innerHTML = "SİSTEM AKTİF - SES ÇALIYOR";
        startBtn.style.display = 'none';
        
    } catch (err) {
        status.innerHTML = `<span style="color:red">HATA: ${err.message}</span>`;
        console.error(err);
    }
}

startBtn.addEventListener('click', startSystem);
</script>
</body>
</html>
