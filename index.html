<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW 4.20i Full-Vision Sync</title>
    <style>
        body { background: #000; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        video { position: absolute; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }
        
        /* Telemetri Katmanı */
        .hud { 
            position: absolute; top: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 12px;
            border-right: 4px solid #e74c3c; color: #fff; pointer-events: none;
        }
        #rpmDisplay { font-size: 32px; font-weight: 900; color: #e74c3c; }
        
        #startBtn { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 200; padding: 25px 50px; background: #fff; color: #000;
            font-weight: bold; border: none; border-radius: 10px; cursor: pointer; font-size: 1.2rem;
        }

        /* Debug Noktası: Sistemin nereyi gördüğünü gösterir */
        #trackerDot {
            position: absolute; width: 15px; height: 15px; background: cyan;
            border-radius: 50%; z-index: 150; display: none; border: 2px solid white;
        }
    </style>
</head>
<body>

    <button id="startBtn">SİSTEMİ VE MOTORU BAŞLAT</button>
    <div id="trackerDot"></div>

    <div class="hud">
        <div style="font-size: 10px; color: #888; letter-spacing: 1px;">BMW 4.20i AUTO-TRACKER</div>
        <div id="rpmDisplay">0% RPM</div>
    </div>

    <video id="liveCam" autoplay muted playsinline></video>

<script>
let audioCtx, source, gainNode, filter;
let smoothedRpm = 0, lastRpmValue = 0;
const video = document.getElementById('liveCam');
const rpmDisplay = document.getElementById('rpmDisplay');
const startBtn = document.getElementById('startBtn');
const trackerDot = document.getElementById('trackerDot');

async function initSystem() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", frameRate: { ideal: 60 } } 
        });
        video.srcObject = stream;
        
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        // Önbelleği aşmak ve büyük harf WAV sorununu çözmek için
        const response = await fetch('./motor_sesi.WAV?v=' + Date.now());
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;
        
        filter = audioCtx.createBiquadFilter(); filter.type = "lowpass";
        gainNode = audioCtx.createGain();
        source.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
        source.start(0);

        startBtn.style.display = 'none';
        trackerDot.style.display = 'block';
        updateLoop();
    } catch (err) { alert("Hata: " + err); }
}

function updateLoop() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement('canvas');
        canvas.width = 100; // Hız için düşük çözünürlüklü analiz
        canvas.height = 100;
        const ctx = canvas.getContext('2d', {alpha: false});
        ctx.drawImage(video, 0, 0, 100, 100);
        
        const data = ctx.getImageData(0, 0, 100, 100).data;
        let highestY = 100;
        let bestX = 50;

        // Tam ekranın sağ %60'lık kısmını tara (BMW barı genellikle sağdadır)
        for (let y = 0; y < 100; y++) {
            for (let x = 40; x < 100; x++) {
                const i = (y * 100 + x) * 4;
                const r = data[i], g = data[i+1], b = data[i+2];

                // BMW Kırmızısı/Turuncusu Filtresi (Videonuzdaki renk analizi baz alındı)
                if (r > 170 && r > g * 1.3 && b < 100) {
                    if (y < highestY) {
                        highestY = y;
                        bestX = x;
                    }
                }
            }
        }

        // RPM Hesaplama: Ekranın altından yukarısına doğru doluluk
        // $$RPM = 1 - (highestY / 100)$$
        let rpmTarget = 1 - (highestY / 100);
        rpmTarget = Math.max(0, Math.min(1, (rpmTarget - 0.1) * 1.2)); // Kalibrasyon

        smoothedRpm += (rpmTarget - smoothedRpm) * 0.25;
        
        // Görsel Geri Bildirim (Tracker)
        trackerDot.style.left = bestX + "vw";
        trackerDot.style.top = highestY + "vh";

        applyAudio(smoothedRpm);
        rpmDisplay.innerText = `${Math.round(smoothedRpm * 100)}% RPM`;
    }
    requestAnimationFrame(updateLoop);
}

function applyAudio(val) {
    const t = audioCtx.currentTime;
    
    // Pop & Bang (Vites Geçişi Algılama)
    if (lastRpmValue - val > 0.12) {
        gainNode.gain.setValueAtTime(1.5, t);
        gainNode.gain.exponentialRampToValueAtTime(0.3 + (val * 0.7), t + 0.15);
    }
    lastRpmValue = val;

    // Pitch: $$PlaybackRate = 0.8 + (RPM \times 3.4)$$
    source.playbackRate.setTargetAtTime(0.8 + (val * 3.4), t, 0.02);
    if (gainNode.gain.value < 1.2) {
        gainNode.gain.setTargetAtTime(0.3 + (val * 0.7), t, 0.02);
    }
    filter.frequency.setTargetAtTime(1200 + (val * 18000), t, 0.02);
}

startBtn.addEventListener('click', initSystem);
</script>
</body>
</html>
