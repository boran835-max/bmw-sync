<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW 4.20i Vision-Sync</title>
    <style>
        body { background: #000; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        video { width: 100vw; height: 100vh; object-fit: cover; }
        .hud { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.85); padding: 20px; border-radius: 12px; border-right: 5px solid #e74c3c; color: #fff; z-index: 100; min-width: 150px; }
        #startBtn { position: absolute; z-index: 200; padding: 20px 60px; background: #fff; color: #000; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 1.3rem; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        canvas#debugCanvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 50; opacity: 0.4; }
    </style>
</head>
<body>

    <button id="startBtn">SİSTEMİ VE MOTORU BAŞLAT</button>
    
    <div class="hud">
        <div style="font-size: 11px; color: #888; letter-spacing: 1px;">BMW 4.20i AUTO-TRACKER</div>
        <div id="rpmText" style="font-size: 28px; font-weight: 900; color: #e74c3c; margin-top: 5px;">%0 RPM</div>
    </div>

    <video id="liveCam" autoplay muted playsinline></video>
    <canvas id="debugCanvas"></canvas>

<script>
let audioCtx, source, gainNode, filter;
let smoothedRpm = 0, lastRpm = 0;
const video = document.getElementById('liveCam');
const debugCanvas = document.getElementById('debugCanvas');
const dCtx = debugCanvas.getContext('2d', { alpha: false });
const rpmText = document.getElementById('rpmText');
const startBtn = document.getElementById('startBtn');

async function initEngine() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", frameRate: { ideal: 60 } } 
        });
        video.srcObject = stream;
        
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        const response = await fetch('./motor_sesi.WAV?v=' + Date.now());
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;

        filter = audioCtx.createBiquadFilter(); filter.type = "lowpass";
        gainNode = audioCtx.createGain();

        source.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
        source.start(0);
        startBtn.style.display = 'none';
        updateLoop();
    } catch (err) { alert("Sistem hatası: " + err); }
}

function updateLoop() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        debugCanvas.width = 160; // Düşük çözünürlüklü analiz = Yüksek hız
        debugCanvas.height = 120;
        
        // Sadece RPM barının olduğu sağ tarafı analiz et
        dCtx.drawImage(video, video.videoWidth * 0.6, video.videoHeight * 0.2, video.videoWidth * 0.35, video.videoHeight * 0.6, 0, 0, 160, 120);
        
        const frame = dCtx.getImageData(0, 0, 160, 120);
        const data = frame.data;
        let highestActivePixelY = 120;

        for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2];
            // BMW'nin aktif bar rengini (parlak beyaz/turuncu/kırmızı) algıla
            if (r > 180 && g > 120) { 
                const y = Math.floor((i / 4) / 160);
                if (y < highestActivePixelY) highestActivePixelY = y;
            }
        }

        // Doluluk oranını hesapla (Matematiksel normalizasyon)
        let rpmTarget = 1 - (highestActivePixelY / 120);
        rpmTarget = Math.max(0, Math.min(1, rpmTarget * 1.2)); // Kalibrasyon çarpanı

        smoothedRpm += (rpmTarget - smoothedRpm) * 0.2; // Yumuşatma
        
        applyAudio(smoothedRpm);
        rpmText.innerText = `%${Math.round(smoothedRpm * 100)} RPM`;
    }
    requestAnimationFrame(updateLoop);
}

function applyAudio(val) {
    const t = audioCtx.currentTime;
    
    // Pop & Bang (Vites Geçişi Algılama)
    if (lastRpm - val > 0.12) {
        gainNode.gain.cancelScheduledValues(t);
        gainNode.gain.setValueAtTime(1.5, t);
        gainNode.gain.exponentialRampToValueAtTime(0.3 + (val * 0.7), t + 0.15);
    }
    lastRpm = val;

    // Pitch: $$PlaybackRate = 0.8 + (RPM \times 3.4)$$
    source.playbackRate.setTargetAtTime(0.8 + (val * 3.4), t, 0.02);
    if (gainNode.gain.value < 1.1) {
        gainNode.gain.setTargetAtTime(0.3 + (val * 0.7), t, 0.02);
    }
    filter.frequency.setTargetAtTime(1000 + (val * 18000), t, 0.02);
}

startBtn.addEventListener('click', initEngine);
</script>
</body>
</html>
