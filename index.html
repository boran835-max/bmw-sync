<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW 4.20i Fix-Sync</title>
    <style>
        body { background: #000; margin: 0; overflow: hidden; font-family: sans-serif; color: white; }
        video { position: absolute; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }
        
        /* Çerçeve: Görünmüyorsa z-index ve border'ı sağlama alıyoruz */
        #analysisFrame { 
            position: absolute; border: 3px solid #ff0000; background: rgba(255, 0, 0, 0.2);
            z-index: 1000; touch-action: none; display: none;
            width: 150px; height: 250px; top: 20%; left: 60%;
        }
        
        .ui-layer { position: absolute; bottom: 30px; z-index: 2000; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        button { padding: 18px 40px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 18px; }
        #startBtn { background: #3498db; color: white; }
        #lockBtn { background: #2ecc71; color: white; display: none; }
        
        .status-panel { 
            position: absolute; top: 10px; left: 10px; z-index: 2000; 
            background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px;
            font-size: 12px; border: 1px solid #444; pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="status-panel" id="debugInfo">
        DURUM: BEKLENİYOR...<br>
        KAMERA: KAPALI<br>
        SES: YÜKLENMEDİ
    </div>
    
    <div id="analysisFrame"></div>

    <div class="ui-layer">
        <button id="startBtn">SİSTEMİ BAŞLAT</button>
        <button id="lockBtn">ALANI KİLİTLE VE SENKRON ET</button>
    </div>

    <video id="liveCam" autoplay muted playsinline></video>

<script>
let audioCtx, source, gainNode, filter;
let smoothedRpm = 0, lastRpm = 0, isLocked = false;
let framePos = { x: window.innerWidth * 0.6, y: window.innerHeight * 0.2, w: 150, h: 250 };

const video = document.getElementById('liveCam');
const debug = document.getElementById('debugInfo');
const frame = document.getElementById('analysisFrame');
const startBtn = document.getElementById('startBtn');
const lockBtn = document.getElementById('lockBtn');

// 1. KAMERA VE SESİ TETİKLE
async function startApp() {
    debug.innerHTML = "DURUM: BAŞLATILIYOR...<br>KAMERA: İZİN BEKLENİYOR";
    
    try {
        // Kamera Erişimi
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", frameRate: { ideal: 60 } } 
        });
        video.srcObject = stream;
        debug.innerHTML = "DURUM: KAMERA AKTİF<br>SES: DOSYA ÇEKİLİYOR...";
        
        // Ses Erişimi
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        const response = await fetch('./motor_sesi.WAV?v=' + Date.now()); // Büyük harf WAV!
        
        if (!response.ok) throw new Error("Dosya bulunamadı (404)");
        
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;
        
        filter = audioCtx.createBiquadFilter();
        gainNode = audioCtx.createGain();
        source.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
        source.start(0);

        // Başarılıysa UI'ı Göster
        startBtn.style.display = 'none';
        lockBtn.style.display = 'block';
        frame.style.display = 'block'; // Çerçeveyi burada açıyoruz
        debug.innerHTML = "DURUM: HAZIR<br>SES: AKTİF<br>EYLEM: ÇERÇEVEYİ YERLEŞTİR";
        
        setupDraggable();
    } catch (err) {
        debug.innerHTML = `<span style="color:red">HATA: ${err.message}</span><br>İpucu: Dosya adını 'motor_sesi.WAV' yapın ve kameraya izin verin.`;
        console.error(err);
    }
}

// 2. ÇERÇEVE HAREKETİ (Touch-Safe)
function setupDraggable() {
    let active = false, initialX, initialY;

    frame.addEventListener("touchstart", (e) => {
        if (isLocked) return;
        active = true;
        initialX = e.touches[0].clientX - framePos.x;
        initialY = e.touches[0].clientY - framePos.y;
    });

    window.addEventListener("touchmove", (e) => {
        if (!active || isLocked) return;
        framePos.x = e.touches[0].clientX - initialX;
        framePos.y = e.touches[0].clientY - initialY;
        frame.style.left = framePos.x + "px";
        frame.style.top = framePos.y + "px";
    });

    window.addEventListener("touchend", () => active = false);
}

// 3. ANALİZ DÖNGÜSÜ
function runAnalysis() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && isLocked) {
        const canvas = document.createElement('canvas');
        canvas.width = 150; canvas.height = 250;
        const ctx = canvas.getContext('2d', { alpha: false });

        const sx = (framePos.x / window.innerWidth) * video.videoWidth;
        const sy = (framePos.y / window.innerHeight) * video.videoHeight;
        const sw = (framePos.w / window.innerWidth) * video.videoWidth;
        const sh = (framePos.h / window.innerHeight) * video.videoHeight;

        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, 150, 250);
        const data = ctx.getImageData(0, 0, 150, 250).data;
        
        let highestRedY = 250;
        for (let i = 0; i < data.length; i += 16) {
            if (data[i] > 160 && data[i] > data[i+1] * 1.5) { // BMW Kırmızısı
                const y = Math.floor((i / 4) / 150);
                if (y < highestRedY) highestRedY = y;
            }
        }

        let rpm = 1 - (highestRedY / 250);
        smoothedRpm += (rpm - smoothedRpm) * 0.2;
        
        // Ses Güncelleme
        const t = audioCtx.currentTime;
        source.playbackRate.setTargetAtTime(0.8 + (smoothedRpm * 3.4), t, 0.02);
        gainNode.gain.setTargetAtTime(0.3 + (smoothedRpm * 0.7), t, 0.02);
        
        debug.innerHTML = `SİSTEM KİLİTLİ<br>RPM: %${Math.round(smoothedRpm * 100)}`;
    }
    requestAnimationFrame(runAnalysis);
}

startBtn.addEventListener('click', startApp);
lockBtn.addEventListener('click', () => {
    isLocked = true;
    lockBtn.style.display = 'none';
    frame.style.border = "2px dashed #2ecc71";
    frame.style.background = "transparent";
    runAnalysis();
});
</script>
</body>
</html>
