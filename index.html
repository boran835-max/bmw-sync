<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW 4.20i Precision Sync</title>
    <style>
        body { background: #000; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        video { position: absolute; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }
        
        /* Analiz Çerçevesi Stili */
        #analysisFrame { 
            position: absolute; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.15);
            z-index: 100; touch-action: none; display: none; box-shadow: 0 0 15px rgba(231, 76, 60, 0.5);
        }
        #analysisFrame::after { content: 'RPM ANALİZ ALANI (Sürükle/Boyutlandır)'; position: absolute; top: -20px; left: 0; font-size: 10px; color: #e74c3c; white-space: nowrap; }
        
        .ui-layer { position: absolute; bottom: 30px; z-index: 200; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        button { padding: 15px 35px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #startBtn { background: #3498db; color: white; }
        #lockBtn { background: #2ecc71; color: white; display: none; }
        
        .hud { position: absolute; top: 20px; left: 20px; z-index: 200; color: #fff; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 8px; border-left: 4px solid #e74c3c; font-family: monospace; pointer-events: none; }
    </style>
</head>
<body>

    <div class="hud" id="status">ADIM 1: Sistemi Başlat.</div>
    
    <div id="analysisFrame"></div>

    <div class="ui-layer">
        <button id="startBtn">SİSTEMİ VE KAMERAYI AÇ</button>
        <button id="lockBtn">ÇERÇEVEYİ KİLİTLE VE BAŞLAT</button>
    </div>

    <video id="liveCam" autoplay muted playsinline></video>

<script>
let audioCtx, source, gainNode, filter;
let smoothedRpm = 0, lastRpm = 0;
let isLocked = false;

// Çerçeve Ayarları
const frame = document.getElementById('analysisFrame');
let framePos = { x: window.innerWidth * 0.6, y: window.innerHeight * 0.3, w: 150, h: 250 };

const video = document.getElementById('liveCam');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const lockBtn = document.getElementById('lockBtn');

// 1. KAMERA VE SES BAŞLATMA
async function initSystem() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", frameRate: { ideal: 60 } } 
        });
        video.srcObject = stream;
        
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        const response = await fetch('./motor_sesi.WAV?v=' + Date.now()); //
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;
        
        filter = audioCtx.createBiquadFilter(); filter.type = "lowpass";
        gainNode = audioCtx.createGain();
        source.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
        source.start(0);

        startBtn.style.display = 'none';
        lockBtn.style.display = 'block';
        frame.style.display = 'block';
        updateFrameUI();
        status.innerText = "ADIM 2: Çerçeveyi RPM barının üzerine sürükle.";
        setupDraggable();
    } catch (err) { alert("Sistem hatası: " + err); }
}

// 2. ÇERÇEVE SÜRÜKLEME MANTIĞI
function setupDraggable() {
    let active = false, currentX, currentY, initialX, initialY;

    frame.addEventListener("touchstart", (e) => {
        if (isLocked) return;
        initialX = e.touches[0].clientX - framePos.x;
        initialY = e.touches[0].clientY - framePos.y;
        active = true;
    });

    window.addEventListener("touchend", () => active = false);

    window.addEventListener("touchmove", (e) => {
        if (!active || isLocked) return;
        framePos.x = e.touches[0].clientX - initialX;
        framePos.y = e.touches[0].clientY - initialY;
        updateFrameUI();
    });
}

function updateFrameUI() {
    frame.style.left = framePos.x + "px";
    frame.style.top = framePos.y + "px";
    frame.style.width = framePos.w + "px";
    frame.style.height = framePos.h + "px";
}

// 3. ANALİZ DÖNGÜSÜ
function updateLoop() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && isLocked) {
        const canvas = document.createElement('canvas');
        canvas.width = 300; // Daha yüksek çözünürlüklü analiz alanı
        canvas.height = 400;
        const ctx = canvas.getContext('2d', { alpha: false });

        // Çerçeve alanını videodan kırpıp al
        const sx = (framePos.x / window.innerWidth) * video.videoWidth;
        const sy = (framePos.y / window.innerHeight) * video.videoHeight;
        const sw = (framePos.w / window.innerWidth) * video.videoWidth;
        const sh = (framePos.h / window.innerHeight) * video.videoHeight;

        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, 300, 400);
        const data = ctx.getImageData(0, 0, 300, 400).data;
        
        let highestY = 400;
        for (let i = 0; i < data.length; i += 16) { // Hassas tarama
            if (data[i] > 165 && data[i] > data[i+1] * 1.5) { // BMW Kırmızısı
                const y = Math.floor((i / 4) / 300);
                if (y < highestY) highestY = y;
            }
        }

        let rpmTarget = 1 - (highestY / 400);
        smoothedRpm += (rpmTarget - smoothedRpm) * 0.25;
        
        applyAudio(smoothedRpm);
        status.innerText = `BMW 4.20i | RPM: %${Math.round(smoothedRpm * 100)}`;
    }
    requestAnimationFrame(updateLoop);
}

function applyAudio(val) {
    const t = audioCtx.currentTime;
    // Pop & Bang Algoritması
    if (lastRpm - val > 0.14) {
        gainNode.gain.setValueAtTime(1.5, t);
        gainNode.gain.exponentialRampToValueAtTime(0.3 + (val * 0.7), t + 0.12);
    }
    lastRpm = val;
    source.playbackRate.setTargetAtTime(0.8 + (val * 3.4), t, 0.02);
    if (gainNode.gain.value < 1.2) {
        gainNode.gain.setTargetAtTime(0.3 + (val * 0.7), t, 0.02);
    }
    filter.frequency.setTargetAtTime(1200 + (val * 18000), t, 0.02);
}

startBtn.addEventListener('click', initSystem);
lockBtn.addEventListener('click', () => {
    isLocked = true;
    lockBtn.style.display = 'none';
    frame.style.borderColor = "#2ecc71"; // Kilitlendiğinde yeşil olur
    frame.style.background = "transparent";
    updateLoop();
});
</script>
</body>
</html>
