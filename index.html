<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW 4.20i Pedal-Tilt Pro</title>
    <style>
        body { background: #0a0a0a; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .gauge-container { width: 250px; height: 250px; border: 10px solid #222; border-top-color: #e74c3c; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.1s; }
        .rpm-value { font-size: 4rem; font-weight: 900; color: #e74c3c; }
        .ui-box { margin-top: 30px; text-align: center; }
        button { padding: 20px 50px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 1.2rem; background: #fff; color: #000; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        #status { margin-top: 15px; font-family: monospace; color: #888; font-size: 12px; }
    </style>
</head>
<body>

    <div class="gauge-container" id="visualGauge">
        <div class="rpm-value" id="rpmText">0</div>
    </div>

    <div class="ui-box">
        <button id="startBtn">SENSÖRÜ VE SESİ BAŞLAT</button>
        <div id="status">BMW 4.20i | PEDAL SENSÖRÜ HAZIR</div>
    </div>

<script>
let audioCtx, source, gainNode, filter;
let baseAngle = null; // Rölanti açısı
let smoothedRpm = 0;
let lastRpm = 0;

const rpmText = document.getElementById('rpmText');
const visualGauge = document.getElementById('visualGauge');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');

async function initPedalSystem() {
    try {
        // 1. Sensör İzni (iOS 13+ için kritik)
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission !== 'granted') throw new Error("Sensör izni reddedildi.");
        }

        // 2. Ses Motorunu Başlat
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        await audioCtx.resume();

        // BMW 4.20i motor sesini çek
        const response = await fetch('./motor_sesi.WAV?v=' + Date.now());
        if (!response.ok) throw new Error("Ses dosyası (WAV) bulunamadı.");
        
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;
        
        filter = audioCtx.createBiquadFilter(); filter.type = "lowpass";
        gainNode = audioCtx.createGain();
        source.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
        source.start(0);

        startBtn.style.display = 'none';
        status.innerText = "SİSTEM AKTİF: GAZA BASIN";
        
        // 3. Dinleyiciyi Başlat
        window.addEventListener('deviceorientation', handlePedal);
    } catch (err) {
        status.innerHTML = `<span style="color:red">HATA: ${err.message}</span>`;
    }
}

function handlePedal(event) {
    // Beta açısını (telefonun öne/arkaya eğimi) baz alıyoruz
    let currentAngle = event.beta;

    // İlk açıyı rölanti (0 RPM) olarak kalibre et
    if (baseAngle === null) baseAngle = currentAngle;

    // Pedala ne kadar basıldığını hesapla (Örn: 30 derecelik eğim tam gaz kabul edilir)
    let diff = currentAngle - baseAngle;
    let rpmTarget = Math.max(0, Math.min(1, diff / 30)); 

    // Yumuşatma (Hassas bir sürüş hissi için)
    smoothedRpm += (rpmTarget - smoothedRpm) * 0.2;
    
    updateAudio(smoothedRpm);
    
    // UI Güncelleme
    rpmText.innerText = Math.round(smoothedRpm * 7000);
    visualGauge.style.transform = `scale(${1 + (smoothedRpm * 0.2)})`;
    visualGauge.style.borderColor = smoothedRpm > 0.8 ? '#ff0000' : '#e74c3c';
}

function updateAudio(val) {
    const t = audioCtx.currentTime;
    
    // Vites Geçişi (Pop & Bang) - Ani pedal bırakmada tetiklenir
    if (lastRpm - val > 0.15) {
        gainNode.gain.setValueAtTime(1.6, t);
        gainNode.gain.exponentialRampToValueAtTime(0.3 + (val * 0.7), t + 0.1);
    }
    lastRpm = val;

    // Pitch: 0.8 (Rölanti) - 4.2 (Limit)
    source.playbackRate.setTargetAtTime(0.8 + (val * 3.4), t, 0.015);
    if (gainNode.gain.value < 1.3) {
        gainNode.gain.setTargetAtTime(0.3 + (val * 0.7), t, 0.015);
    }
    filter.frequency.setTargetAtTime(1000 + (val * 19000), t, 0.015);
}

startBtn.addEventListener('click', initPedalSystem);
</script>
</body>
</html>
